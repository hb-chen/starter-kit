---
kind: pipeline
type: docker
name: gateway

platform:
  arch: amd64
  os: linux

workspace:
  path: github.com/micro-in-cn/starter-kit

trigger:
  branch:
    - gateway
steps:
  - name: build
    image: golang:1.13-alpine
    environment:
      GOOS: linux
      GOARCH: amd64
      CGO_ENABLED: 0
      GOPROXY: https://mirrors.aliyun.com/goproxy/
      GOSUMDB: off
    commands:
      - pwd
      - go version
      - cd gateway
      - go build -o ./bin/linux_amd64/micro main.go plugin.go
      - ./bin/linux_amd64/micro --version
    when:
      branch:
        - gateway
      event:
        - push
  - name: publish
    image: plugins/docker
    settings:
      auto_tag: true
      dockerfile: ./gateway/Dockerfile
      context: ./gateway
      repo: hbchen/starter-kit-gateway
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
    when:
      branch:
        - gateway
      event:
        - push
  - name: deploy
    image: dtzar/helm-kubectl:3.1.1
    environment:
      SERVER:
        from_secret: k8s_server
      CERTIFICATE_AUTHORITY_DATA:
        from_secret: k8s_ca
      USER_TOKEN:
        from_secret: k8s_token
    commands:
      - kubectl config set-cluster k8s --server="$${SERVER}"
      - kubectl config set clusters.k8s.certificate-authority-data "$${CERTIFICATE_AUTHORITY_DATA}"
      - kubectl config set-credentials k8s-admin --token="$${USER_TOKEN}"
      - kubectl config set-context default --cluster=k8s --user=k8s-admin
      - kubectl config use-context default
      - helm template micro ./deploy/k8s/helm/starter-kit/charts/gateway --namespace starter-kit --set micro.host=starter-kit.k8s.hbchen.com --set image.tag=${DRONE_TAG=latest} --set image.pullPolicy=Always --set serviceAccount.create=true --set serviceAccount.name=micro-services | kubectl apply -f -
    when:
      branch:
        - gateway
      event:
        - push

---
kind: pipeline
type: docker
name: console

platform:
  arch: amd64
  os: linux

workspace:
  path: github.com/micro-in-cn/starter-kit

trigger:
  branch:
    - console
steps:
# vue build太慢暂时不把web放在里面
#  - name: build-web-vue
#    image: node:10.16.3-alpine
#    commands:
#      - pwd
#      - cd console/web/vue
#      - npm install
#      - export VUE_APP_BASE_API=
#      - npm run build:prod
#    when:
#      branch:
#        - console
#      event:
#        - push
  - name: build-all
    image: golang:1.13-alpine
    environment:
      GOOS: linux
      GOARCH: amd64
      CGO_ENABLED: 0
      GOPROXY: https://mirrors.aliyun.com/goproxy/
      GOSUMDB: off
    commands:
      - pwd
      - go version
      - cd console/api
      - go build -o ./bin/linux_amd64/console-api main.go plugin.go
      #- ./bin/linux_amd64/console-api --version
#      - cd ../web
#      - go version
#      - go build -o ./bin/linux_amd64/console-web main.go plugin.go
      #- ./bin/linux_amd64/console-web --version
      - cd ../account
      - go version
      - go build -o ./bin/linux_amd64/account-srv main.go plugin.go
      #- ./bin/linux_amd64/account-srv --version
    when:
      branch:
        - console
      event:
        - push
  - name: publish-api
    image: plugins/docker
    settings:
      auto_tag: true
      dockerfile: ./console/api/Dockerfile
      context: ./console/api
      repo: hbchen/starter-kit-console-api
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
    when:
      branch:
        - console
      event:
        - push
  - name: deploy-api
    image: dtzar/helm-kubectl:3.1.1
    environment:
      SERVER:
        from_secret: k8s_server
      CERTIFICATE_AUTHORITY_DATA:
        from_secret: k8s_ca
      USER_TOKEN:
        from_secret: k8s_token
    commands:
      - kubectl config set-cluster k8s --server="$${SERVER}"
      - kubectl config set clusters.k8s.certificate-authority-data "$${CERTIFICATE_AUTHORITY_DATA}"
      - kubectl config set-credentials k8s-admin --token="$${USER_TOKEN}"
      - kubectl config set-context default --cluster=k8s --user=k8s-admin
      - kubectl config use-context default
      - helm template micro ./deploy/k8s/helm/starter-kit/charts/service --namespace starter-kit --set nameOverride=console-api --set image.repository=hbchen/starter-kit-console-api --set image.tag=${DRONE_TAG=latest} --set image.pullPolicy=Always --set serviceAccount.create=true --set serviceAccount.name=micro-services | kubectl apply -f -
    when:
      branch:
        - console
      event:
        - push
#  - name: publish-web
#    image: plugins/docker
#    settings:
#      auto_tag: true
#      dockerfile: ./console/web/Dockerfile
#      context: ./console/web
#      repo: hbchen/starter-kit-console-web
#      username:
#        from_secret: docker_username
#      password:
#        from_secret: docker_password
#    when:
#      branch:
#        - console
#      event:
#        - push
#  - name: deploy-web
#    image: dtzar/helm-kubectl:3.1.1
#    environment:
#      SERVER:
#        from_secret: k8s_server
#      CERTIFICATE_AUTHORITY_DATA:
#        from_secret: k8s_ca
#      USER_TOKEN:
#        from_secret: k8s_token
#    commands:
#      - kubectl config set-cluster k8s --server="$${SERVER}"
#      - kubectl config set clusters.k8s.certificate-authority-data "$${CERTIFICATE_AUTHORITY_DATA}"
#      - kubectl config set-credentials k8s-admin --token="$${USER_TOKEN}"
#      - kubectl config set-context default --cluster=k8s --user=k8s-admin
#      - kubectl config use-context default
#      - helm template micro ./deploy/k8s/helm/starter-kit/charts/service --namespace starter-kit --set nameOverride=console-web --set image.repository=hbchen/starter-kit-console-web --set image.tag=${DRONE_TAG=latest} --set image.pullPolicy=Always --set serviceAccount.create=true --set serviceAccount.name=micro-services | kubectl apply -f -
#    when:
#      branch:
#        - console
#      event:
#        - push
  - name: publish-account
    image: plugins/docker
    settings:
      auto_tag: true
      dockerfile: ./console/account/Dockerfile
      context: ./console/account
      repo: hbchen/starter-kit-console-account
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
    when:
      branch:
        - console
      event:
        - push
  - name: deploy-account
    image: dtzar/helm-kubectl:3.1.1
    environment:
      SERVER:
        from_secret: k8s_server
      CERTIFICATE_AUTHORITY_DATA:
        from_secret: k8s_ca
      USER_TOKEN:
        from_secret: k8s_token
    commands:
      - kubectl config set-cluster k8s --server="$${SERVER}"
      - kubectl config set clusters.k8s.certificate-authority-data "$${CERTIFICATE_AUTHORITY_DATA}"
      - kubectl config set-credentials k8s-admin --token="$${USER_TOKEN}"
      - kubectl config set-context default --cluster=k8s --user=k8s-admin
      - kubectl config use-context default
      - helm template micro ./deploy/k8s/helm/starter-kit/charts/service --namespace starter-kit --set nameOverride=console-api --set image.repository=hbchen/starter-kit-console-account --set image.tag=${DRONE_TAG=latest} --set image.pullPolicy=Always --set serviceAccount.create=true --set serviceAccount.name=micro-services | kubectl apply -f -
    when:
      branch:
        - console
      event:
        - push
